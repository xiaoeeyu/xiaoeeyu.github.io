<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>Cobalt-Strike-九 免杀（一）</title><meta name="description" content="May the Force be with you"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/rabete.jpg"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="Veil免杀安装网上有很多的安装方法：安装很简单输入命令sudo apt install veil然后一直确定下一步就可以了，安装时间较长


安装方法
安装的过程中先使用CS生成一个payload




使用安装完成后输入veil可以启动veil工具

安装完成可以看到有 Evasion和Ordnace 两个工具：Evasion是用来做==文件免杀==的一般来说选用的比较多



输入use 1选用Evasion
list查看可用的payloads


输入use 17这里我们选择一个go 的注入payload


输入generate选择生成payload


输入3选择自定义类型字符串，然后将我们前面生成的payload放进去回车执行


然后再给输入个名字：不需要输入后缀名


将生成后的文件拷贝.."><script src="//unpkg.com/valine/dist/Valine.min.js"></script><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">xiaoeryu's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Cobalt-Strike-九 免杀（一）</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Veil%E5%85%8D%E6%9D%80"><span class="toc-text">Veil免杀</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-text">使用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HanzoInjection-%E6%96%B9%E6%B3%95"><span class="toc-text">HanzoInjection 方法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Invoke-PSImage"><span class="toc-text">Invoke-PSImage</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#python-%E7%94%9F%E6%88%90%E5%85%8D%E6%9D%80"><span class="toc-text">python 生成免杀</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/-Cobalt%20Strike"><i class="tag post-item-tag">-Cobalt Strike</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">Cobalt-Strike-九 免杀（一）</h1><time class="has-text-grey" datetime="2021-06-03T09:10:49.000Z">2021-06-03</time><article class="mt-2 post-content"><h1 id="Veil免杀"><a href="#Veil免杀" class="headerlink" title="Veil免杀"></a>Veil免杀</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>网上有很多的安装方法：安装很简单输入命令<code>sudo apt install veil</code>然后一直确定下一步就可以了，安装时间较长</p>
<span id="more"></span>

<p><a target="_blank" rel="noopener" href="https://wizardforcel.gitbooks.io/daxueba-kali-linux-tutorial/content/34.html">安装方法</a></p>
<p>安装的过程中先使用CS生成一个payload</p>
<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210603175954456.png" class="" title="image-20210603175954456">

<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210603180034103.png" class="" title="image-20210603180034103">

<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>安装完成后输入<code>veil</code>可以启动veil工具</p>
<ul>
<li>安装完成可以看到有 Evasion和Ordnace 两个工具：Evasion是用来做==文件免杀==的一般来说选用的比较多</li>
</ul>
<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210603172156128.png" class="" title="image-20210603172156128">

<p>输入<code>use 1</code>选用Evasion</p>
<p><code>list</code>查看可用的payloads</p>
<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210603173115641.png" class="" title="image-20210603173115641">

<p>输入<code>use 17</code>这里我们选择一个go 的注入payload</p>
<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210603175156926.png" class="" title="image-20210603175156926">

<p>输入<code>generate</code>选择生成payload</p>
<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210603175316286.png" class="" title="image-20210603175316286">

<p>输入<code>3</code>选择自定义类型字符串，然后将我们前面生成的payload放进去回车执行</p>
<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210603180319964.png" class="" title="image-20210603180319964">

<p>然后再给输入个名字：不需要输入后缀名</p>
<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210603180433135.png" class="" title="image-20210603180433135">

<p>将生成后的文件拷贝出来拿到vt上查杀一下</p>
<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210603180639766.png" class="" title="image-20210603180639766">

<p>被一大半的杀软检测出来了(安装了360和火绒也过不去，会直接被检测出来)</p>
<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210603180948241.png" class="" title="image-20210603180948241">

<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210603181020402.png" class="" title="image-20210603181020402">

<h1 id="HanzoInjection-方法"><a href="#HanzoInjection-方法" class="headerlink" title="HanzoInjection 方法"></a>HanzoInjection 方法</h1><p>HanzoIjection 是一种工具，专注于在内存中注入任意代码以绕过常见的防病毒解决方案</p>
<p><a target="_blank" rel="noopener" href="https://github.com/P0cL4bs/hanzoInjection">下载链接</a></p>
<pre><code>Arguments Options:

        OPTION        TYPE       DESCRIPTION
       -e,--execute  [.raw]      Name of file.bin, payload metasploit type raw
       -p,--payload  [.raw]      Payload meterpreter type [RAW]  requered parameter -o [output]
       -o,--output   [file.cs]   Output generate project file.cs injection memory payload c#
       -h,--help     [Help]      show this help and exit

Example Usage:

        HanzoInjection.exe -e payload_meterpreter.bin
        HanzoInjection.exe -p meterpreter.bin -o injection_memory.cs
</code></pre>
<ol>
<li><p>用CS先生成一个二进制的bin文件</p>
<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210606165614118.png" class="" title="image-20210606165614118">
</li>
<li><p>在安装过杀软的目标机器上用hanzoljection加载执行</p>
<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210606165849918.png" class="" title="image-20210606165849918">
</li>
<li><p>执行成功，并在服务端上线成功</p>
<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210606170014912.png" class="" title="image-20210606170014912"></li>
</ol>
<h1 id="Invoke-PSImage"><a href="#Invoke-PSImage" class="headerlink" title="Invoke-PSImage"></a>Invoke-PSImage</h1><p>在 PNG 文件的像素中对 PowerShell 脚本进行编码，并生成要执行的 oneliner</p>
<p>Invoke-PSImage 使用 PowerShell 脚本并将脚本的字节编码为 PNG 图像的像素。它生成一个oneliner，用于从网络上的文件或文件中执行。</p>
<p>它可以仅使用有效载荷数据创建新图像，也可以将有效载荷嵌入现有图像的最低有效字节中，使其看起来像一张真实的图片。图像保存为 PNG，并且可以无损压缩而不会影响执行有效负载的能力，因为数据存储在颜色本身中。创建新图像时，普通的 PowerShell 脚本实际上会被显着压缩，通常会生成文件大小约为原始脚本 50% 的 png。</p>
<p>使用嵌入方法，每个像素中 2 个颜色值的最低有效 4 位用于保存有效负载。图像质量会因此而受到影响，但看起来仍然不错。它可以接受大多数图像类型作为输入，但输出将始终是 PNG，因为它需要无损。图像的每个像素用于保存一个字节的脚本，因此您将需要一个像素数至少与脚本中的字节数一样多的图像。这相当容易——例如，Invoke-Mimikatz 适合 1920x1200 图像。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/peewpw/Invoke-PSImage">下载地址</a></p>
<p>下载并解压后先往目录里面导入两个文件</p>
<ol>
<li><p>1920x1200的图片</p>
</li>
<li><p>cs生成的一个powershell脚本</p>
<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210606174420618.png" class="" title="image-20210606174420618">
</li>
<li><p>开始执行命令</p>
</li>
</ol>
<pre><code class="powershell">Powershell -ExecutionPolicy Bypass	// 允许导入外部脚本执行
Import-Module .\Invoke-PSImage.ps1
Invoke-PSImage -Script .\payload.ps1 -Image .\test_1.jpg –Out test_2.png –web
</code></pre>
<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210606183056654.png" class="" title="image-20210606183056654">

<ol start="4">
<li>将图片上传至CS服务器</li>
</ol>
<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210606183557547.png" class="" title="image-20210606183557547">



<ol start="5">
<li><p>执行完最后一条命令（时间比较久得几分钟）后会产生一个链接将链接复制出来</p>
</li>
<li><p>并且将圈起来的地方替换为我们cs服务端图片存放位置的链接</p>
</li>
</ol>
<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210606183307333.png" class="" title="image-20210606183307333">

<ol start="7">
<li>替换后，在目标机上用powershell执行命令后可以看到360和火绒没有任何拦截上线成功</li>
</ol>
<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210606183733739.png" class="" title="image-20210606183733739">

<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210606184238473.png" class="" title="image-20210606184238473">

<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210606184334467.png" class="" title="image-20210606184334467">



<h1 id="python-生成免杀"><a href="#python-生成免杀" class="headerlink" title="python 生成免杀"></a>python 生成免杀</h1><p>生成python文件</p>
<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210606185136044.png" class="" title="image-20210606185136044">

<img src="/2021/06/03/Cobalt-Strike-%E4%B9%9D-%E5%85%8D%E6%9D%80/image-20210606185200136.png" class="" title="image-20210606185200136">



<p>然后使用pyinstaller进行免杀</p>
<pre><code class="css">pyinstaller -F -w -i 1.exe payload.py
-i 代表选取的图标的名字 也可以为1.ico
-f 表示生成一个单的文件
-w表示在windows环境下不打开窗口运行 
payload.py即表示文件生成的
</code></pre>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2021/06/07/Cobalt-Strike-%E5%8D%81-%E5%8F%AF%E6%8C%81%E7%BB%AD%E5%90%8E%E9%97%A8%E7%9A%84%E4%BD%BF%E7%94%A8/" title="Cobalt-Strike-十-可持续后门的使用"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">上一页: Cobalt-Strike-十-可持续后门的使用</span></a><a class="button is-default" href="/2021/06/02/Cobalt-Strike-%E5%85%AB-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/" title="Cobalt-Strike-八 提权"><span class="has-text-weight-semibold">下一页: Cobalt-Strike-八 提权</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="Haojen/Claudia-theme-blog" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article><article class="mt-6 comment-container" id="vcomments"></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com//"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/xiaoeryu"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com//"><i class="iconfont icon-ins"></i></a><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com//"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright ©</span><span> xiaoeryu 2022</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>