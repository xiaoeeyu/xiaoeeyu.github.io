<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>一枚简单的未知壳</title><meta name="description" content="May the Force be with you"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/rabete.jpg"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="工具&amp;amp;环境:


工具
系统环境



PEID
win7_x86


OD



IDA



imporREC



查壳先用PEID扫了一下发现什么都没有扫到 


直接先用OD打开看一下发现有pushad/fd先用ESP定律下断试一下 
嗯,直接就这样到了,F7几下就到了OEP 
这里有个sub esp,0x58所以应该是Delphi写的,第一个call本来应该显示getversion的,但是并没有,发现它IAT加密了 OEP是47148B 
那我们先跟进去看一下
这里有对ebx一个sub和add运算看了一下发现它获取到了GetVersion的地址 
但是0x475080还是它WriteIAT的地址,所以在这里下硬件写入断点,然后重新运行寻找它GetAPI的地方 
F9了两次发现这个地方像是.."><script src="//unpkg.com/valine/dist/Valine.min.js"></script><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">xiaoeryu's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">一枚简单的未知壳</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7-amp-%E7%8E%AF%E5%A2%83"><span class="toc-text">工具&amp;环境:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E5%A3%B3"><span class="toc-text">查壳</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E5%85%88%E7%94%A8OD%E6%89%93%E5%BC%80%E7%9C%8B%E4%B8%80%E4%B8%8B"><span class="toc-text">直接先用OD打开看一下</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8OEP%E5%A4%84%E5%8F%B3%E9%94%AE%E4%BD%BF%E7%94%A8OllyDump%E5%B0%86%E7%A8%8B%E5%BA%8Fdump%E5%87%BA%E6%9D%A5"><span class="toc-text">在OEP处右键使用OllyDump将程序dump出来</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%84%B6%E5%90%8E%E7%94%A8imporREC%E4%BF%AE%E5%A4%8D%E4%B8%80%E4%B8%8Bdump%E5%87%BA%E6%9D%A5%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%AF%BC%E5%85%A5%E8%A1%A8%E5%B0%B1%E5%8F%AF%E4%BB%A5%E4%BA%86"><span class="toc-text">然后用imporREC修复一下dump出来程序的导入表就可以了</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E6%88%90"><span class="toc-text">完成</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/%E8%84%B1%E5%A3%B3"><i class="tag post-item-tag">脱壳</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">一枚简单的未知壳</h1><time class="has-text-grey" datetime="2021-05-24T07:29:04.000Z">2021-05-24</time><article class="mt-2 post-content"><h3 id="工具-amp-环境"><a href="#工具-amp-环境" class="headerlink" title="工具&amp;环境:"></a>工具&amp;环境:</h3><table>
<thead>
<tr>
<th align="left">工具</th>
<th>系统环境</th>
</tr>
</thead>
<tbody><tr>
<td align="left">PEID</td>
<td>win7_x86</td>
</tr>
<tr>
<td align="left">OD</td>
<td></td>
</tr>
<tr>
<td align="left">IDA</td>
<td></td>
</tr>
<tr>
<td align="left">imporREC</td>
<td></td>
</tr>
</tbody></table>
<h3 id="查壳"><a href="#查壳" class="headerlink" title="查壳"></a>查壳</h3><p>先用PEID扫了一下发现什么都没有扫到<br> <img src="/2021/05/24/%E4%B8%80%E6%9E%9A%E7%AE%80%E5%8D%95%E7%9A%84%E6%9C%AA%E7%9F%A5%E5%A3%B3/623a1200-5054-432b-9613-8ceb28562e82.jpg" class="" title="img"></p>
<span id="more"></span>

<h3 id="直接先用OD打开看一下"><a href="#直接先用OD打开看一下" class="headerlink" title="直接先用OD打开看一下"></a>直接先用OD打开看一下</h3><p>发现有pushad/fd先用ESP定律下断试一下<br> <img src="/2021/05/24/%E4%B8%80%E6%9E%9A%E7%AE%80%E5%8D%95%E7%9A%84%E6%9C%AA%E7%9F%A5%E5%A3%B3/1a8bec0d-3c8f-4a42-9dfc-fe11ac4d4c4b.png" class="" title="img"></p>
<p>嗯,直接就这样到了,F7几下就到了OEP<br> <img src="/2021/05/24/%E4%B8%80%E6%9E%9A%E7%AE%80%E5%8D%95%E7%9A%84%E6%9C%AA%E7%9F%A5%E5%A3%B3/b7135dff-2520-480a-a78e-aa78ced4f978.png" class="" title="img"></p>
<p>这里有个sub esp,0x58所以应该是Delphi写的,第一个call本来应该显示getversion的,但是并没有,发现它IAT加密了<br> <strong>OEP是47148B</strong><br> <img src="/2021/05/24/%E4%B8%80%E6%9E%9A%E7%AE%80%E5%8D%95%E7%9A%84%E6%9C%AA%E7%9F%A5%E5%A3%B3/5ad9befa-e19c-4abc-bd97-b797a6eab5d7.png" class="" title="img"></p>
<p>那我们先跟进去看一下</p>
<p>这里有对ebx一个sub和add运算看了一下发现它获取到了GetVersion的地址<br> <img src="/2021/05/24/%E4%B8%80%E6%9E%9A%E7%AE%80%E5%8D%95%E7%9A%84%E6%9C%AA%E7%9F%A5%E5%A3%B3/e9bfd6e4-da02-45b2-a55c-01a8255ace15.png" class="" title="img"></p>
<p>但是0x475080还是它WriteIAT的地址,所以在这里下硬件写入断点,然后重新运行寻找它GetAPI的地方<br> <img src="/2021/05/24/%E4%B8%80%E6%9E%9A%E7%AE%80%E5%8D%95%E7%9A%84%E6%9C%AA%E7%9F%A5%E5%A3%B3/0d728ff3-108c-4eb6-893b-03cff517cce4.png" class="" title="img"></p>
<p>F9了两次发现这个地方像是写入IAT的地方<br> <img src="/2021/05/24/%E4%B8%80%E6%9E%9A%E7%AE%80%E5%8D%95%E7%9A%84%E6%9C%AA%E7%9F%A5%E5%A3%B3/9a384b9c-9fd8-46b7-aaa1-50feca86de32.png" class="" title="img"><br> <strong>那这个1D0897应该是WriteIATAddr了</strong></p>
<p>在0x2F0895这个地方下断用run跟踪F7跑一下<br> <img src="/2021/05/24/%E4%B8%80%E6%9E%9A%E7%AE%80%E5%8D%95%E7%9A%84%E6%9C%AA%E7%9F%A5%E5%A3%B3/0.2970275629542105.png" class="" title="img"></p>
<p><strong>run跟踪的原理就是模拟操作然后全部记录在run跟踪窗口中</strong><br> <img src="/2021/05/24/%E4%B8%80%E6%9E%9A%E7%AE%80%E5%8D%95%E7%9A%84%E6%9C%AA%E7%9F%A5%E5%A3%B3/0.8923110284070546.png" class="" title="img"></p>
<p>在写入iat的地方下断点,然后run跟踪,运行到下一次写入的时候就会断下来,<br> <img src="/2021/05/24/%E4%B8%80%E6%9E%9A%E7%AE%80%E5%8D%95%E7%9A%84%E6%9C%AA%E7%9F%A5%E5%A3%B3/31d0751c-1485-47a0-83c3-c72f0cf354cb.png" class="" title="img"></p>
<p>然后进run跟踪的界面,找到7*******开头往这个eax里面写入的地址就是GetAPIAddr了</p>
<p>可以看到这里获取到了API的地址<br> <img src="/2021/05/24/%E4%B8%80%E6%9E%9A%E7%AE%80%E5%8D%95%E7%9A%84%E6%9C%AA%E7%9F%A5%E5%A3%B3/275a6cef-4ad9-46a0-a894-a661aae2bc0a.png" class="" title="img"></p>
<p>这个地方就可以用了,也可以再往上找一下eax是从哪来的</p>
<p>找到是从这个地方获取的<br> <img src="/2021/05/24/%E4%B8%80%E6%9E%9A%E7%AE%80%E5%8D%95%E7%9A%84%E6%9C%AA%E7%9F%A5%E5%A3%B3/40552cb0-1999-4878-b33f-1707b93ec133.png" class="" title="img"><br> <strong>1D1914或者1D0474</strong><br> <strong>我们写脱壳脚本的时候GetAPI用这两个地址都可以</strong></p>
<pre><code>// 定义变量,初始化变量 
VAR dwGetAPIAddr 
VAR dwWriteIATAddr 
VAR dwOEP VAR dwTmp 
MOV dwGetAPIAddr, 001D0474     // 获取 API 地址的地方      
MOV dwWriteIATAddr, 001D0897   // 填充 IAT 的地方 
MOV dwOEP, 0047148B            // OEP
// 清理环境 
BC     // 清理软件断点 
BPHWC  // 清理硬件断点 
BPMC   // 清理内存断点 
// 设置断点 
BPHWS dwOEP, "x" 
BPHWS dwGetAPIAddr, "x" 
BPHWS dwWriteIATAddr, "x"
// 构造循环 
LOOP1:  
// 运行程序 
RUN 
// 判断 是 获取 API 地址的地方 
cmp eip,dwGetAPIAddr 
JNZ SIGN1 
MOV dwTmp, eax 
jmp LOOP1   
// 判断 是 填充 IAT 的地方 
SIGN1: 
cmp eip,dwWriteIATAddr 
JNZ SIGN2  
MOV [edx],dwTmp 
jmp LOOP1  
// 判断是 OEP ，结束了 
SIGN2: 
cmp eip,dwOEP 
JZ EXIT1 
jmp LOOP1  // 脚本结束 
EXIT1: 
MSG "yes，今晚吃鸡！"
</code></pre>
<p>等脚本跑完 修复完导入表</p>
<h3 id="在OEP处右键使用OllyDump将程序dump出来"><a href="#在OEP处右键使用OllyDump将程序dump出来" class="headerlink" title="在OEP处右键使用OllyDump将程序dump出来"></a>在OEP处右键使用OllyDump将程序dump出来</h3><img src="/2021/05/24/%E4%B8%80%E6%9E%9A%E7%AE%80%E5%8D%95%E7%9A%84%E6%9C%AA%E7%9F%A5%E5%A3%B3/37b4e9f6-c4c2-4952-960c-f569a9303764.png" class="" title="img">

<h3 id="然后用imporREC修复一下dump出来程序的导入表就可以了"><a href="#然后用imporREC修复一下dump出来程序的导入表就可以了" class="headerlink" title="然后用imporREC修复一下dump出来程序的导入表就可以了"></a>然后用imporREC修复一下dump出来程序的导入表就可以了</h3><img src="/2021/05/24/%E4%B8%80%E6%9E%9A%E7%AE%80%E5%8D%95%E7%9A%84%E6%9C%AA%E7%9F%A5%E5%A3%B3/image-20210524164615794.png" class="" title="image-20210524164615794">

<h3 id="完成"><a href="#完成" class="headerlink" title="完成"></a>完成</h3><img src="/2021/05/24/%E4%B8%80%E6%9E%9A%E7%AE%80%E5%8D%95%E7%9A%84%E6%9C%AA%E7%9F%A5%E5%A3%B3/image-20210524153137607.png" class="" title="image-20210524153137607">

</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2021/05/24/Ocean-Lotus%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90/" title="Ocean Lotus样本分析"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">上一页: Ocean Lotus样本分析</span></a><a class="button is-default" href="/2021/05/21/HW%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90/" title="HW样本分析"><span class="has-text-weight-semibold">下一页: HW样本分析</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="Haojen/Claudia-theme-blog" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article><article class="mt-6 comment-container" id="vcomments"></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com//"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/xiaoeryu"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com//"><i class="iconfont icon-ins"></i></a><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com//"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright ©</span><span> xiaoeryu 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>