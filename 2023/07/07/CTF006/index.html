<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>CTF006</title><meta name="description" content="May the Force be with you"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/rabete.jpg"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="

1. 用jadx查看入口点在AndroidManifest.xml里面找到入口函数




1.1. 看这段代码我们需要关注两个方法：  1. getSecret()是一个native层的函数，这个函数对编辑框的内容进行了一定的处理之后返回了ans
  2. check()方法校验，通过校验才能得到正确的Flag

先分析下chek()是怎么实现的，等下再去看native层。
2. 查看check()方法

这段代码的主要作用是从数据库中取出secret值（用hello的MD5值作为name对应的secret值）与我们输入的值（经过getSecret()方法处理）进行比较相等就返回true。


分析完check()方法之后，现在我们可知：

输入编辑框的值经过getSecret()的运算之后 = ‘k.."><script src="//unpkg.com/valine/dist/Valine.min.js"></script><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">xiaoeryu's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">CTF006</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%94%A8jadx%E6%9F%A5%E7%9C%8B%E5%85%A5%E5%8F%A3%E7%82%B9"><span class="toc-text">1. 用jadx查看入口点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E7%9C%8B%E8%BF%99%E6%AE%B5%E4%BB%A3%E7%A0%81%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E5%85%B3%E6%B3%A8%E4%B8%A4%E4%B8%AA%E6%96%B9%E6%B3%95%EF%BC%9A"><span class="toc-text">1.1. 看这段代码我们需要关注两个方法：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9F%A5%E7%9C%8Bcheck-%E6%96%B9%E6%B3%95"><span class="toc-text">2. 查看check()方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%88%86%E6%9E%90getSecret"><span class="toc-text">3. 分析getSecret()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-%E7%94%A8ida%E6%89%93%E5%BC%80so%E6%96%87%E4%BB%B6%E4%B9%8B%E5%90%8E%EF%BC%8C%E9%80%9A%E8%BF%87%E5%91%BD%E5%90%8D%E6%83%AF%E4%BE%8B%E7%94%A8java%E5%AE%9A%E4%BD%8D%E5%88%B0%E5%87%BD%E6%95%B0%E4%BD%8D%E7%BD%AE%EF%BC%8C%E5%86%8D%E6%8C%89F5%E4%BF%AE%E6%94%B9%E4%BB%A5%E4%B8%8B%E5%8F%82%E6%95%B0%E7%B1%BB%E5%9E%8B%E6%96%B9%E4%BE%BF%E5%88%86%E6%9E%90"><span class="toc-text">3.1. 用ida打开so文件之后，通过命名惯例用java定位到函数位置，再按F5修改以下参数类型方便分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-%E5%85%88%E5%88%9D%E6%AD%A5%E5%88%86%E6%9E%90%E8%BF%99%E6%AE%B5%E4%BB%A3%E7%A0%81%E6%9D%A5%E7%8C%9C%E6%B5%8B%E9%87%8C%E9%9D%A2%E7%9A%84%E9%80%BB%E8%BE%91%EF%BC%88%E5%9B%A0%E4%B8%BA%E4%B8%8D%E7%9F%A5%E9%81%93%E5%8F%82%E6%95%B0%E7%9A%84%E5%86%85%E5%AE%B9%EF%BC%8C%E6%89%80%E4%BB%A5%E7%8C%9C%E6%B5%8B%E4%B8%8D%E4%B8%80%E5%AE%9A%E6%AD%A3%E7%A1%AE%EF%BC%89%E6%88%91%E4%BB%AC%E4%BE%9D%E6%97%A7%E5%8F%AF%E4%BB%A5%E7%9F%A5%E9%81%93%E5%87%A0%E7%82%B9"><span class="toc-text">3.2. 先初步分析这段代码来猜测里面的逻辑（因为不知道参数的内容，所以猜测不一定正确）我们依旧可以知道几点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E7%94%A8ida%E5%8A%A8%E6%80%81%E9%99%84%E5%8A%A0%E8%B0%83%E8%AF%95%EF%BC%9Aattach%E8%BF%87%E7%A8%8B%E7%95%A5%E8%BF%87"><span class="toc-text">4. 用ida动态附加调试：attach过程略过</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-attach%E7%A8%8B%E5%BA%8F%E4%B9%8B%E5%90%8E%EF%BC%8C%E6%89%BE%E5%88%B0%E6%88%91%E4%BB%AC%E7%9A%84getSecret-%E6%96%B9%E6%B3%95%E4%B8%8B%E6%96%AD%E7%82%B9%E6%AE%B5%E4%B8%8B%E6%9D%A5"><span class="toc-text">4.1. attach程序之后，找到我们的getSecret()方法下断点段下来</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E6%8E%A5%E4%B8%8B%E6%9D%A5%E5%BC%80%E5%A7%8B%E5%88%86%E6%9E%90for%E5%BE%AA%E7%8E%AF"><span class="toc-text">4.2. 接下来开始分析for循环</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E7%84%B6%E5%90%8E%E8%BF%99%E4%B8%AA%E5%8A%A0%E5%AF%86%E6%88%91%E4%BB%AC%E5%B0%B1%E5%85%A8%E9%83%A8%E5%88%86%E6%9E%90%E5%AE%8C%E6%88%90%E4%BA%86%EF%BC%8C%E4%BF%AE%E6%94%B9%E4%B8%80%E4%B8%8B%E6%88%91%E4%BB%AC%E5%89%8D%E9%9D%A2%E7%8C%9C%E9%94%99%E7%9A%84%E4%BC%AA%E4%BB%A3%E7%A0%81%E6%B3%A8%E9%87%8A"><span class="toc-text">5. 然后这个加密我们就全部分析完成了，修改一下我们前面猜错的伪代码注释</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90%E5%AE%8C%E6%88%90"><span class="toc-text">算法分析完成</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%AF%86"><i class="tag post-item-tag">加密解密</i></a><a href="/tags/Android%20CTF"><i class="tag post-item-tag">Android CTF</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">CTF006</h1><time class="has-text-grey" datetime="2023-07-07T14:50:00.000Z">2023-07-07</time><article class="mt-2 post-content"><img src="/2023/07/07/CTF006/image-20230708111943817.png" class="" title="image-20230708111943817">

<h3 id="1-用jadx查看入口点"><a href="#1-用jadx查看入口点" class="headerlink" title="1. 用jadx查看入口点"></a>1. 用jadx查看入口点</h3><p>在<em>AndroidManifest.xml</em>里面找到入口函数</p>
<span id="more"></span>

<img src="/2023/07/07/CTF006/image-20230708112024572.png" class="" title="image-20230708112024572">

<h4 id="1-1-看这段代码我们需要关注两个方法："><a href="#1-1-看这段代码我们需要关注两个方法：" class="headerlink" title="1.1. 看这段代码我们需要关注两个方法："></a>1.1. 看这段代码我们需要关注两个方法：</h4><pre><code>  1. getSecret()是一个native层的函数，这个函数对编辑框的内容进行了一定的处理之后返回了ans
  2. check()方法校验，通过校验才能得到正确的Flag
</code></pre>
<p>先分析下chek()是怎么实现的，等下再去看native层。</p>
<h3 id="2-查看check-方法"><a href="#2-查看check-方法" class="headerlink" title="2. 查看check()方法"></a>2. 查看check()方法</h3><img src="/2023/07/07/CTF006/image-20230708123143622.png" class="" title="image-20230708123143622">

<p>这段代码的主要作用是从数据库中取出<strong>secret</strong>值（用hello的MD5值作为name对应的secret值）与我们输入的值（经过getSecret()方法处理）进行比较相等就返回true。</p>
<img src="/2023/07/07/CTF006/image-20230708123203528.png" class="" title="image-20230708123203528">

<p>分析完check()方法之后，现在我们可知：</p>
<ul>
<li>输入编辑框的值经过getSecret()的运算之后 = ‘kEvKc|roAkNADgGExUeq’就可以通过校验</li>
</ul>
<p>那接下来我们去分析一下getSecret()这个方法。</p>
<h3 id="3-分析getSecret"><a href="#3-分析getSecret" class="headerlink" title="3. 分析getSecret()"></a>3. 分析getSecret()</h3><h4 id="3-1-用ida打开so文件之后，通过命名惯例用java定位到函数位置，再按F5修改以下参数类型方便分析"><a href="#3-1-用ida打开so文件之后，通过命名惯例用java定位到函数位置，再按F5修改以下参数类型方便分析" class="headerlink" title="3.1. 用ida打开so文件之后，通过命名惯例用java定位到函数位置，再按F5修改以下参数类型方便分析"></a>3.1. 用ida打开so文件之后，通过命名惯例用java定位到函数位置，再按F5修改以下参数类型方便分析</h4><img src="/2023/07/07/CTF006/image-20230708123314917.png" class="" title="image-20230708123314917">

<h4 id="3-2-先初步分析这段代码来猜测里面的逻辑（因为不知道参数的内容，所以猜测不一定正确）我们依旧可以知道几点"><a href="#3-2-先初步分析这段代码来猜测里面的逻辑（因为不知道参数的内容，所以猜测不一定正确）我们依旧可以知道几点" class="headerlink" title="3.2. 先初步分析这段代码来猜测里面的逻辑（因为不知道参数的内容，所以猜测不一定正确）我们依旧可以知道几点"></a>3.2. 先初步分析这段代码来猜测里面的逻辑（因为不知道参数的内容，所以猜测不一定正确）我们依旧可以知道几点</h4><pre><code>  1. 代码通过接收我们输入的字符串，将其和内置的base_string进行一些运算得到一个新的字符串，最后将新的字符串返回
  2. 因为最后返回的新字符串是动态生成的，所以我们无法通过简单的hook去获取到正确的flag
  3. 这样子的话我们只能尝试一下看，能不能通过分析它的算法和入参写出它的反解算法
  4. 我们要详细分析算法写反解脚本的话，需要通过动态调试的方法来确定它的入参和返回值，另外静态反编译出来的伪代码可能也不准确不能支持我们去精确的写出反解算法
</code></pre>
<h3 id="4-用ida动态附加调试：attach过程略过"><a href="#4-用ida动态附加调试：attach过程略过" class="headerlink" title="4. 用ida动态附加调试：attach过程略过"></a>4. 用ida动态附加调试：attach过程略过</h3><h4 id="4-1-attach程序之后，找到我们的getSecret-方法下断点段下来"><a href="#4-1-attach程序之后，找到我们的getSecret-方法下断点段下来" class="headerlink" title="4.1. attach程序之后，找到我们的getSecret()方法下断点段下来"></a>4.1. attach程序之后，找到我们的getSecret()方法下断点段下来</h4><img src="/2023/07/07/CTF006/image-20230708123611283.png" class="" title="image-20230708123611283">

<img src="/2023/07/07/CTF006/image-20230708123621214.png" class="" title="image-20230708123621214">

<p>在函数开始的地方下断点，在手机上点击_<strong>TRY IT!</strong>_按钮之后我们可以中断在这里，这时候我们可以看到它的<strong>base_string</strong>字符串<br>_F8_继续往下跟，到获取dest[]的地方</p>
<img src="/2023/07/07/CTF006/image-20230708123650927.png" class="" title="image-20230708123650927">

<img src="/2023/07/07/CTF006/image-20230708123700143.png" class="" title="image-20230708123700143">

<p>分析后可以发现数组的内容是从0~0x44的dw数组。</p>
<h4 id="4-2-接下来开始分析for循环"><a href="#4-2-接下来开始分析for循环" class="headerlink" title="4.2. 接下来开始分析for循环"></a>4.2. 接下来开始分析for循环</h4><p><strong>第一个for循环</strong></p>
<img src="/2023/07/07/CTF006/image-20230708123740861.png" class="" title="image-20230708123740861">

<ul>
<li><p>循环的次数根据组的长度获得</p>
</li>
<li><p>循环取出dest[i]中的值 + <strong>0x10</strong>，然后再写回去</p>
<p><strong>第二个嵌套for循环</strong></p>
</li>
</ul>
<img src="/2023/07/07/CTF006/image-20230708123755894.png" class="" title="image-20230708123755894">

<ul>
<li>外层循环的次数是我们输入的字符串的长度</li>
<li>内存循环的次数是base_string字符串的长度</li>
<li>这个嵌套循环是将我们输入的字符逐个和base_string中的字符对比，相等的话就跳出本轮内层循环</li>
</ul>
<img src="/2023/07/07/CTF006/image-20230708123825332.png" class="" title="image-20230708123825332">

<p>用循环次数去dest[]中取出对应的值-&gt;再用这个取出的值去base_string中取出对应下标的字符-&gt;然后用这个字符替换掉我们输入的inputStr[外层循环]的字符</p>
<p><strong>最后一个循环</strong></p>
<img src="/2023/07/07/CTF006/image-20230708123945089.png" class="" title="image-20230708123945089">

<ul>
<li>最后一个循环时将我们前面循环生成的新字符串再次循环进行<strong>^</strong>操作，然后放回原位、</li>
</ul>
<h3 id="5-然后这个加密我们就全部分析完成了，修改一下我们前面猜错的伪代码注释"><a href="#5-然后这个加密我们就全部分析完成了，修改一下我们前面猜错的伪代码注释" class="headerlink" title="5. 然后这个加密我们就全部分析完成了，修改一下我们前面猜错的伪代码注释"></a>5. 然后这个加密我们就全部分析完成了，修改一下我们前面猜错的伪代码注释</h3><img src="/2023/07/07/CTF006/image-20230708124023310.png" class="" title="image-20230708124023310">

<h3 id="算法分析完成"><a href="#算法分析完成" class="headerlink" title="算法分析完成"></a>算法分析完成</h3><p>接下来我们就可以写这个算法的反解脚本了，写反解脚本可以从最后一个循环往前推过去</p>
<p><strong>结果字符串循环对字符进行与运算，然后再取模128确保结果不大于ASCII码的最大值-&gt;然后将计算完成的字符逐个在base_string里面找到字符对应的索引值(即dest[k]的值)-&gt;如果这个索引值小于16(dest[]中的最小值0x10)表示它对应的索引值在base_string的前16位-&gt;就把下标值加上base_string的长度-&gt;最后打印字符的时候还要把索引值([dest[i]])减去0x10</strong></p>
<pre><code class="python">static_str = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!{|}~'
now = 'kEvKc|roAkNADgGExUeq'
for i, each in enumerate(now):
    tmp = chr((ord(each)^i)%128)
    index = static_str.find(tmp)
    if index &lt; 16:
        index = index + len(static_str) # 如果index &lt; 16，给index加上字符集长度实现循环查找
    print(static_str[index-16], end='')
</code></pre>
<img src="/2023/07/07/CTF006/image-20230708124148899.png" class="" title="image-20230708124148899">

<p><strong>over~</strong></p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2023/07/08/CTF005/" title="CTF005"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">上一页: CTF005</span></a><a class="button is-default" href="/2022/12/11/32-%E5%B9%B3%E5%9D%A6%E6%A8%A1%E5%9E%8B/" title="32. 平坦模型"><span class="has-text-weight-semibold">下一页: 32. 平坦模型</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="Haojen/Claudia-theme-blog" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article><article class="mt-6 comment-container" id="vcomments"></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com//"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/xiaoeryu"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com//"><i class="iconfont icon-ins"></i></a><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com//"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright ©</span><span> xiaoeryu 2023</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>